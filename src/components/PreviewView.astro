---
interface Props {
  src: string
}

const { src } = Astro.props
---

<preview-view data-src={src}>
  <button
    type="button"
    aria-label="Toggle preview mode"
    aria-pressed="true"
    class="inline-flex items-center justify-center gap-2 rounded-md border border-gray-200 bg-white px-3 py-1.5 text-sm font-medium text-gray-900 transition-colors hover:bg-gray-50 disabled:pointer-events-none disabled:opacity-50"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="1.5"
      stroke="currentColor"
      class="size-4"
      data-preview
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"
      ></path>
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
      ></path>
    </svg>

    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 20 20"
      fill="currentColor"
      class="hidden size-4"
      data-code
    >
      <path
        fill-rule="evenodd"
        d="M6.28 5.22a.75.75 0 0 1 0 1.06L2.56 10l3.72 3.72a.75.75 0 0 1-1.06 1.06L.97 10.53a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0Zm7.44 0a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L17.44 10l-3.72-3.72a.75.75 0 0 1 0-1.06ZM11.377 2.011a.75.75 0 0 1 .612.867l-2.5 14.5a.75.75 0 0 1-1.478-.255l2.5-14.5a.75.75 0 0 1 .866-.612Z"
        clip-rule="evenodd"></path>
    </svg>

    <span data-text>Preview</span>
  </button>
</preview-view>

<script>
  class PreviewView extends HTMLElement {
    private contentSrc: string | null = null

    private clickHandler: (() => void) | null = null

    connectedCallback() {
      this.contentSrc = this.dataset.src || null

      if (!this.contentSrc) {
        return
      }

      const buttonEl = this.querySelector('button')

      if (!buttonEl) {
        return
      }

      const previewIcon = buttonEl.querySelector('svg[data-preview]')
      const codeIcon = buttonEl.querySelector('svg[data-code]')
      const buttonText = buttonEl.querySelector('span[data-text]')

      if (!previewIcon || !codeIcon || !buttonText) {
        return
      }

      this.clickHandler = () => {
        const isPreviewing = buttonEl.getAttribute('aria-pressed') === 'true'
        const newState = !isPreviewing

        buttonEl.setAttribute('aria-pressed', String(newState))

        if (newState) {
          previewIcon.classList.remove('hidden')
          codeIcon.classList.add('hidden')
          buttonText.textContent = 'Preview'
        } else {
          previewIcon.classList.add('hidden')
          codeIcon.classList.remove('hidden')
          buttonText.textContent = 'HTML'
        }

        document.dispatchEvent(
          new CustomEvent(`preview:view:${this.contentSrc}`, {
            bubbles: true,
            detail: { previewing: newState },
          }),
        )
      }

      buttonEl.addEventListener('click', this.clickHandler)
    }

    disconnectedCallback() {
      const buttonEl = this.querySelector('button')

      if (buttonEl && this.clickHandler) {
        buttonEl.removeEventListener('click', this.clickHandler)

        this.clickHandler = null
      }
    }
  }

  customElements.define('preview-view', PreviewView)
</script>
